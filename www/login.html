<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/login.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic&display=swap" rel="stylesheet">

    <!-- 波 -->
    <link rel="stylesheet" type="text/css" href="css/wave.css">

    <script src="components/loader.js"></script>
    <script>
        // APIキーの設定とSDK初期化
        var ncmb = new NCMB("a59165a217e09aae15a26c95a9e51f8510ea7fbb8da9ad8c15686fa1c5b449e7", "32551b9f4f6afa631f1fc4b63df334ab33683be35b820813931f0e6c156aa4c3");

        ons.ready(function() {
            console.log("Onsen UI is ready!");
        });

        if (ons.platform.isIPhoneX()) {
            document.documentElement.setAttribute('onsflag-iphonex-portrait', '');
            document.documentElement.setAttribute('onsflag-iphonex-landscape', '');
        }

        //ログイン機能
        function login() {

            var loginStudentId = document.getElementById("loginId").value;
            var loginPassword = document.getElementById("loginPass").value;

            var loginFlag = false;

            checkEffectiveness(loginStudentId).then(function(effectiveness) {
                if (loginStudentId === "") {
                    document.getElementById('errMessageLogNum').innerHTML = "メールアドレスが未入力です";
                    loginFlag = true;
                } else if (effectiveness != 0) {
                    document.getElementById('errMessageLogNum').innerHTML = "このアカウントは現在使用できません";
                    loginFlag = true;
                } else {
                    document.getElementById('errMessageLogNum').innerHTML = "";
                }
                if (loginPassword === "") {
                    document.getElementById('errMessageLogPass').innerHTML = "パスワードが未入力です";
                    loginFlag = true;
                } else {
                    document.getElementById('errMessageLogPass').innerHTML = "";
                }
                if (loginFlag) {
                    return;
                }


                ncmb.User.login(loginStudentId, loginPassword)
                    .then(function(user) {
                        //ログイン成功時の処理(例)
                        //console.log("ログイン成功：" + JSON.stringify(user));
                        console.log("ログイン成功：" + ncmb.User.getCurrentUser().user_account_name);
                        document.location.href = './home.html';
                    })
                    .catch(function(error) {
                        //ログイン失敗時の処理
                        console.log("ログイン失敗：" + JSON.stringify(error));
                        document.getElementById('errMessageLogPass').innerHTML = "学籍番号かパスワードが間違っています";
                    });
            });
        }

        //アカウント有効性の確認
        function checkEffectiveness(studentId) {
            return new Promise(function(resolve, reject) {
                ncmb.User.fetchAll()
                    .then(users => {
                        users.forEach(user => {
                            //ここで登録されている学籍番号かチェック
                            if (user.userName === studentId) {
                                var effectiveness = user.effectiveness;
                                resolve(effectiveness);
                            }
                        })
                    }).catch(err => {
                        console.log("変数データ取得エラー" + err);
                    });
            }).catch(err => {
                console.log("checkEffectivenessエラー:" + err);
                reject();
            });
        }

        //学籍番号検索機能
        function wineSearch() {
            var loginStudentId = document.getElementById("searchSN").value;
            let lowNumber = 0;
            ncmb.User.fetchAll()
                .then(users => {
                    users.forEach(user => {
                        //ここで登録されている学籍番号かチェック
                        if (user.userName === loginStudentId) {
                            console.log("あった！");
                            console.log(user.user_account_name);
                            lowNumber = lowNumber + 1;
                        }
                    })
                    console.log("検索結果：" + lowNumber + "件");
                }).catch(err => {
                    console.log("変数データ取得エラー")
                });
        }

        //ログイン中ユーザ確認
        function confarm() {
            // カレントユーザー情報の取得
            // alert("確認")
            var currentUser = ncmb.User.getCurrentUser();
            if (currentUser != null) {
                console.log("ログイン中のユーザー: " + currentUser.get("userName"));
            } else {
                console.log("未ログインまたは取得に失敗");
            }
            // カレントユーザーかどうかの確認
            console.log(currentUser.isCurrentUser()); /* true or false */
        }
    </script>
</head>

<body>

    <img id="wave1" src="img/sky.png" width=100%>
    <div class="wave1">
        <canvas id="waveCanvas1" style="z-index:1"></canvas>
        <script src="js/wave.js"></script>
    </div>

    <div>
        <!--フォーム-->
        <form name="login_form">
            <center>
                <h1 class="contact-title">ログイン</h1>
            </center>
            <div>
                <center>
                    <!--ログイン-->
                    <div class="tab-content">
                        <!--p class="text"-->
                        <input type="id" id="loginId" name="id" placeholder="メールアドレス">
                        <!--/p-->
                        <span id="errMessageLogNum" class="errMessage"><span><br>
                            <!--p class="pass"-->
                            <input type="password" id="loginPass" name="pass" placeholder="パスワード" />
                            <!--/p-->
                            <span id="errMessageLogPass" class="errMessage"></span><br><br>
                        <div class="bt-wine">
                            <a href="javascript:login();" class="bt-samp37">LOGIN</a>
                        </div>
                    </div>
                </center>
            </div>
        </form>
    </div>
    <img id="wave2" src="img/sky.png" width=100%>
    <div class="wave2">

        <canvas id="waveCanvas2"></canvas>
        <script src="js/wave.js"></script>

    </div>
</body>

</html>